<div class="chat-container">
  <div class="header">
    <h2>Cas Clinique : Fracture & Ost√©oporose</h2>
    <div class="progress-bar">
      <div class="progress" [style.width.%]="(currentIndex / scenario.length) * 100">
        {{ (currentIndex / scenario.length) * 100 | number: '1.0-0' }}%
      </div>
    </div>
  </div>

  <div *ngFor="let entry of chatHistory" class="chat-row"
       [ngClass]="{
         'right': entry.from === 'me',
         'narrator': entry.from === 'narrator',
         'left': entry.from !== 'me' && entry.from !== 'narrator'
       }">

    <!-- Narrator Message -->
    <div *ngIf="entry.type === 'message' && entry.from === 'narrator'" class="chat-bubble narrator">
      <div class="message-text narrator-text">
        <span [innerHTML]="entry.text"></span>
      </div>
    </div>

    <!-- Regular Message -->
    <ng-container *ngIf="entry.type === 'message' && entry.from !== 'narrator'">
      <div class="message-container" [ngClass]="entry.from === 'me' ? 'me' : 'other'">
        <div class="speaker-name">{{ entry.from | titlecase }}</div>
        <div class="message-wrapper">
          <img [src]="entry.imageUrl" alt="Profile Image" class="profile-image" />
          <div class="chat-bubble"
               [ngClass]="{
                 'madame-monia': entry.from === 'mme_monia',
                 'me': entry.from === 'me',
                 'doctor': entry.from === 'dr_sami'
               }">
            <div class="message-text">
              <span [innerHTML]="entry.text"></span>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Question -->
    <div *ngIf="entry.type === 'question'" class="chat-bubble game-question">
      <p><strong>{{ entry.data.question }}</strong></p>
      <div class="options">
        <button *ngFor="let key of objectKeys(entry.data.options)"
                mat-raised-button
                [color]="selectedOptions[entry.data.id] && selectedOptions[entry.data.id].has(key) ? 'accent' : 'primary'"
                (click)="toggleOption(entry.data.id, key)">
          {{ key }}. {{ entry.data.options[key].text }}
        </button>
      </div>
      <button *ngIf="selectedOptions[entry.data.id] && selectedOptions[entry.data.id].size > 0"
              mat-raised-button
              color="warn"
              (click)="submitMultipleAnswers()">
        Valider
      </button>
    </div>

    <!-- Feedback -->
    <div *ngIf="entry.type === 'answer'" class="chat-bubble"
         [ngClass]="{ 'correct': entry.correct, 'incorrect': !entry.correct }">
      <em>Feedback: {{ entry.feedback || 'Correct' }}</em>
    </div>
  </div>
</div>
